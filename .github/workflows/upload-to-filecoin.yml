name: Upload to Filecoin

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'logs/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install filecoin-pin
        run: npm install -g filecoin-pin@latest

      - name: Check filecoin-pin version
        run: |
          VERSION=$(filecoin-pin -V)
          echo "filecoin-pin version: $VERSION"

      - name: Create logs directory
        run: mkdir -p logs

      - name: Upload repository to Filecoin
        env:
          PRIVATE_KEY: ${{ secrets.FILECOIN_PRIVATE_KEY }}
          RPC_URL: ${{ secrets.FILECOIN_RPC_URL }}
        run: |
          # Upload entire repo with auto-funding
          # --auto-fund ensures 10-day payment runway before upload
          # Automatically deposits additional USDFC if needed
          OUTPUT=$(filecoin-pin add --auto-fund . 2>&1 | tee upload-output.txt)

          # Extract metadata
          ROOT_CID=$(echo "$OUTPUT" | grep 'Root CID:' | awk '{print $3}' || echo "N/A")
          PIECE_CID=$(echo "$OUTPUT" | grep 'Piece CID:' | awk '{print $3}' || echo "N/A")
          SIZE=$(echo "$OUTPUT" | grep 'Size:' | awk '{print $2}' || echo "N/A")
          PIECE_ID=$(echo "$OUTPUT" | grep 'Piece ID:' | awk '{print $3}' || echo "N/A")
          DATASET_ID=$(echo "$OUTPUT" | grep 'Data Set ID:' | awk '{print $4}' || echo "N/A")
          PROVIDER=$(echo "$OUTPUT" | grep 'Name:' | awk '{print $2}' || echo "N/A")
          TX_HASH=$(echo "$OUTPUT" | grep 'Hash:' | awk '{print $2}' || echo "N/A")
          DOWNLOAD_URL=$(echo "$OUTPUT" | grep 'Direct Download URL:' | awk '{print $4}' || echo "N/A")

          # Extract auto-funding information if present
          AUTO_FUND_DEPOSIT=$(echo "$OUTPUT" | grep 'Deposited' | grep 'USDFC' | awk '{print $2}' || echo "")
          AUTO_FUND_TOTAL=$(echo "$OUTPUT" | grep 'Total deposited:' | awk '{print $3}' || echo "")
          AUTO_FUND_RUNWAY=$(echo "$OUTPUT" | grep 'Runway:' | sed 's/.*Runway: ~//' | sed 's/ .*//' || echo "")
          
          # Save to environment
          echo "ROOT_CID=$ROOT_CID" >> $GITHUB_ENV
          echo "PIECE_CID=$PIECE_CID" >> $GITHUB_ENV
          echo "SIZE=$SIZE" >> $GITHUB_ENV
          echo "DATASET_ID=$DATASET_ID" >> $GITHUB_ENV
          echo "TX_HASH=$TX_HASH" >> $GITHUB_ENV
          echo "AUTO_FUND_DEPOSIT=$AUTO_FUND_DEPOSIT" >> $GITHUB_ENV
          echo "AUTO_FUND_TOTAL=$AUTO_FUND_TOTAL" >> $GITHUB_ENV
          echo "AUTO_FUND_RUNWAY=$AUTO_FUND_RUNWAY" >> $GITHUB_ENV
          
          # Create log file (using filename-friendly timestamp)
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H%M%S")
          LOG_FILE="logs/upload-${TIMESTAMP}.md"

          # Write log content
          echo "# Filecoin Upload Log" > "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "**Upload Time**: ${TIMESTAMP}" >> "$LOG_FILE"
          echo "**Commit**: ${{ github.sha }}" >> "$LOG_FILE"
          echo "**Triggered by**: ${{ github.event_name }}" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "## Upload Metadata" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "| Field | Value |" >> "$LOG_FILE"
          echo "|-------|-------|" >> "$LOG_FILE"
          echo "| **Root CID** | \`${ROOT_CID}\` |" >> "$LOG_FILE"
          echo "| **Piece CID** | \`${PIECE_CID}\` |" >> "$LOG_FILE"
          echo "| **Size** | ${SIZE} |" >> "$LOG_FILE"
          echo "| **Piece ID** | ${PIECE_ID} |" >> "$LOG_FILE"
          echo "| **Data Set ID** | ${DATASET_ID} |" >> "$LOG_FILE"
          echo "| **Storage Provider** | ${PROVIDER} |" >> "$LOG_FILE"
          echo "| **Transaction Hash** | \`${TX_HASH}\` |" >> "$LOG_FILE"
          echo "| **Direct Download URL** | ${DOWNLOAD_URL} |" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"

          # Add auto-funding information if present
          if [ -n "$AUTO_FUND_DEPOSIT" ]; then
            echo "## Auto-Funding Summary" >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"
            echo "ðŸ”‹ **Automatic payment adjustment made:**" >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"
            echo "| Field | Value |" >> "$LOG_FILE"
            echo "|-------|-------|" >> "$LOG_FILE"
            echo "| **Deposited** | ${AUTO_FUND_DEPOSIT} USDFC |" >> "$LOG_FILE"
            echo "| **Total Deposited** | ${AUTO_FUND_TOTAL} USDFC |" >> "$LOG_FILE"
            echo "| **Runway** | ~${AUTO_FUND_RUNWAY} days |" >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"
            echo "> â„¹ï¸ The \`--auto-fund\` flag automatically ensured 10-day minimum payment runway before this upload." >> "$LOG_FILE"
            echo "" >> "$LOG_FILE"
          fi

          echo "## IPFS Gateway Links" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "### ipfs.io Gateway" >> "$LOG_FILE"
          echo "- **Browse repository**: https://ipfs.io/ipfs/${ROOT_CID}" >> "$LOG_FILE"
          echo "- **View walkthrough**: https://ipfs.io/ipfs/${ROOT_CID}/DEMO_WALKTHROUGH.md" >> "$LOG_FILE"
          echo "- **Screenshots directory**: https://ipfs.io/ipfs/${ROOT_CID}/screenshots/" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "### dweb.link Gateway" >> "$LOG_FILE"
          echo "- **Browse repository**: https://${ROOT_CID}.ipfs.dweb.link/" >> "$LOG_FILE"
          echo "- **View walkthrough**: https://${ROOT_CID}.ipfs.dweb.link/DEMO_WALKTHROUGH.md" >> "$LOG_FILE"
          echo "- **Screenshots directory**: https://${ROOT_CID}.ipfs.dweb.link/screenshots/" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "### localhost Gateway (requires local IPFS node)" >> "$LOG_FILE"
          echo "- **Browse repository**: http://${ROOT_CID}.ipfs.localhost:8080/" >> "$LOG_FILE"
          echo "- **View walkthrough**: http://${ROOT_CID}.ipfs.localhost:8080/DEMO_WALKTHROUGH.md" >> "$LOG_FILE"
          echo "- **Screenshots directory**: http://${ROOT_CID}.ipfs.localhost:8080/screenshots/" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "## Transaction Details" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "View on block explorer: https://calibration.filfox.info/tx/${TX_HASH}" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "## File Structure" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "The Root CID contains the complete repository structure:" >> "$LOG_FILE"
          echo "- \`DEMO_WALKTHROUGH.md\` - Main documentation" >> "$LOG_FILE"
          echo "- \`screenshots/\` - All 15 screenshots" >> "$LOG_FILE"
          echo "- Markdown relative paths resolve correctly from the Root CID" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "## Raw Output" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "\`\`\`" >> "$LOG_FILE"
          cat upload-output.txt >> "$LOG_FILE"
          echo "\`\`\`" >> "$LOG_FILE"

          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV

      - name: Commit upload log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/
          git commit -m "docs: add upload log for commit ${{ github.sha }} [skip ci]" || echo "No changes to commit"
          git push

      - name: Create Summary
        run: |
          echo "# ðŸ“¦ Repository Uploaded to Filecoin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ipfs.io Gateway" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View Walkthrough**: https://ipfs.io/ipfs/${{ env.ROOT_CID }}/DEMO_WALKTHROUGH.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Browse All Files**: https://ipfs.io/ipfs/${{ env.ROOT_CID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### dweb.link Gateway" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View Walkthrough**: https://${{ env.ROOT_CID }}.ipfs.dweb.link/DEMO_WALKTHROUGH.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Browse All Files**: https://${{ env.ROOT_CID }}.ipfs.dweb.link/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### localhost Gateway (requires local IPFS node)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **View Walkthrough**: http://${{ env.ROOT_CID }}.ipfs.localhost:8080/DEMO_WALKTHROUGH.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Browse All Files**: http://${{ env.ROOT_CID }}.ipfs.localhost:8080/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Upload Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Root CID**: \`${{ env.ROOT_CID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Piece CID**: \`${{ env.PIECE_CID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ env.SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Set**: #${{ env.DATASET_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Transaction**: [\`${{ env.TX_HASH }}\`](https://calibration.filfox.info/tx/${{ env.TX_HASH }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add auto-funding summary if deposit was made
          if [ -n "${{ env.AUTO_FUND_DEPOSIT }}" ]; then
            echo "## ðŸ”‹ Auto-Funding Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Automatic payment adjustment was made:" >> $GITHUB_STEP_SUMMARY
            echo "- **Deposited**: ${{ env.AUTO_FUND_DEPOSIT }} USDFC" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Deposited**: ${{ env.AUTO_FUND_TOTAL }} USDFC" >> $GITHUB_STEP_SUMMARY
            echo "- **Runway**: ~${{ env.AUTO_FUND_RUNWAY }} days" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> â„¹ï¸ The \`--auto-fund\` flag automatically ensured 10-day minimum payment runway before upload." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“ **Upload log saved**: \`${{ env.LOG_FILE }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: upload-log
          path: |
            logs/
            upload-output.txt
