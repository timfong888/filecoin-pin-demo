# filecoin-pin v0.7.3 --auto-fund Feature Documentation

**Version**: v0.7.3+
**Feature**: `--auto-fund` flag for `add` and `import` commands
**Source**: Analyzed from `/external/filecoin-project/filecoin-pin/src/payments/fund.ts` and related files

## Summary

The `--auto-fund` flag enables automatic funding management when uploading files to Filecoin. It **pre-flight checks** your payment runway BEFORE each upload and automatically deposits funds if needed to maintain a minimum 10-day runway.

## Key Facts

### Where It's Used
- ✅ `filecoin-pin add --auto-fund <path>` - Add files with auto-funding
- ✅ `filecoin-pin import --auto-fund <car-file>` - Import CAR with auto-funding
- ❌ `filecoin-pin payments setup` - NO auto-fund flag here

### What It Does

**Before each upload:**
1. Checks current payment status (deposit, lockup, rate)
2. Calculates how much the new file will cost (lockup + ongoing storage)
3. Determines if current deposit can maintain 10+ days runway AFTER upload
4. If insufficient: **automatically deposits exact amount needed** to reach 10 days
5. If sufficient: proceeds without depositing

### How It Calculates

```typescript
// From fund.ts line 164-166:
const adj = computeAdjustmentForExactDaysWithFile(
  status,           // Current payment status
  MIN_RUNWAY_DAYS,  // Target: 10 days
  fileSize,         // Size of file being uploaded
  pricePerTiBPerEpoch  // Storage provider pricing
)
```

**The calculation accounts for:**
- **Current deposit** - What you have already deposited
- **Current lockup** - Funds locked for existing storage
- **Current rate** - Daily spend for existing storage
- **New file lockup** - Upfront lockup needed for this file
- **New file rate** - Increased daily cost after adding this file
- **Target runway** - 10 days (hardcoded constant)

**Formula (simplified):**
```
Available = CurrentDeposit - CurrentLockup
DailySpendAfterUpload = (CurrentRate + NewFileRate) * EpochsPerDay
DaysOfRunway = Available / DailySpendAfterUpload

If DaysOfRunway < 10:
  Deposit = (10 * DailySpendAfterUpload) - Available + NewFileLockup
```

## Actual Behavior (Based on Source Code)

### Scenario 1: Sufficient Funds (No Action)

**Condition:** Current funds already provide 10+ days runway after upload

**Output:**
```
✓ Funding requirements met
```

**Code path:**
```typescript
// fund.ts lines 170-186
if (delta <= 0n) {
  spinner?.message('No additional funding required')
  return {
    adjusted: false,
    delta: 0n,
    newDepositedAmount: updated.depositedAmount,
    newRunwayDays: newRunway,
    newRunwayHours: newRunwayHours,
  }
}
```

### Scenario 2: Insufficient Funds (Auto-Deposit)

**Condition:** Current funds would result in < 10 days runway after upload

**Output:**
```
✓ Funding requirements met

Auto-funding completed:
  Deposited 6.4 USDFC
  Total deposited: 11.4 USDFC
  Runway: ~10 day(s) 2 hour(s)
  Approval tx: 0x123...
  Transaction: 0x456...
```

**Code path:**
```typescript
// fund.ts lines 188-217
const depositResult = await depositUSDFC(synapse, delta)

return {
  adjusted: true,
  delta,
  approvalTx: depositResult.approvalTx,
  transactionHash: depositResult.depositTx,
  newDepositedAmount: updated.depositedAmount,
  newRunwayDays: newRunway,
  newRunwayHours: newRunwayHours,
}
```

### Scenario 3: Insufficient Wallet Balance (Error)

**Condition:** Need to deposit but wallet doesn't have enough USDFC

**Output:**
```
✗ Auto-funding failed

Error: Insufficient USDFC in wallet (need 15.0 USDFC, have 5.0 USDFC)

Operation cancelled - auto-funding failed
```

**Code path:**
```typescript
// fund.ts lines 189-193
if (delta > usdfcBalance) {
  throw new Error(
    `Insufficient USDFC in wallet (need ${formatUSDFC(delta)} USDFC, have ${formatUSDFC(usdfcBalance)} USDFC)`
  )
}
```

## Integration with Upload Flow

From `common/upload-flow.ts`:

```typescript
// Line 60-100: performAutoFunding function
export async function performAutoFunding(synapse: Synapse, fileSize: number, spinner?: Spinner) {
  spinner?.start('Checking funding requirements for upload...')

  try {
    const fundOptions: AutoFundOptions = {
      synapse,
      fileSize,
    }
    if (spinner !== undefined) {
      fundOptions.spinner = spinner
    }
    const result = await autoFund(fundOptions)
    spinner?.stop(`${pc.green('✓')} Funding requirements met`)

    if (result.adjusted) {
      // Display funding details...
    }
  } catch (error) {
    spinner?.stop(`${pc.red('✗')} Auto-funding failed`)
    // Error handling...
    process.exit(1)
  }
}
```

**When called:**
- Before `validatePaymentSetup()` check
- Before actual upload begins
- Only if `--auto-fund` flag is passed

## Key Differences from Manual Funding

| Aspect | `--auto-fund` (Automatic) | `payments fund` (Manual) |
|--------|---------------------------|--------------------------|
| **When** | Before each upload | When you run the command |
| **Target** | Always 10 days (hardcoded) | Configurable (`--days N` or `--amount N`) |
| **Awareness** | Knows about file being uploaded | Works with current usage only |
| **Calculation** | Current + new file costs | Current costs only |
| **Action** | Deposits only (never withdraws) | Can deposit or withdraw |
| **Confirmation** | Non-interactive (automatic) | Interactive (asks for confirmation) |
| **Use case** | CI/CD, automated uploads | Manual runway management |

## Important Limitations

1. **Fixed 10-day target**: Cannot override the MIN_RUNWAY_DAYS constant without code change
2. **Deposit only**: Will never withdraw excess funds
3. **Per-upload check**: Runs every time you use `add --auto-fund`, even for small files
4. **No setup integration**: Cannot be used with `payments setup` command
5. **Requires payment setup**: Must have run `payments setup` at least once before

## Recommended Usage Patterns

### Pattern 1: CI/CD Pipeline (Best Use Case)
```yaml
# GitHub Actions example
- name: Upload to Filecoin
  run: filecoin-pin add --auto-fund ./dist
```

**Why this works:**
- Automated environment (no interaction)
- Ensures consistent 10-day runway
- Fails fast if wallet empty

### Pattern 2: Initial Setup + Auto-Fund Uploads
```bash
# One-time setup
filecoin-pin payments setup --auto --deposit 50

# Then use auto-fund for all uploads
filecoin-pin add --auto-fund file1.txt
filecoin-pin add --auto-fund file2.txt
filecoin-pin add --auto-fund file3.txt
```

**Why this works:**
- Initial deposit provides buffer
- Auto-fund tops up as needed
- Maintains 10-day minimum automatically

### Pattern 3: Manual Control (When NOT to use --auto-fund)
```bash
# Manual setup with specific amount
filecoin-pin payments setup --auto --deposit 100

# Upload without auto-fund
filecoin-pin add file.txt

# Manually adjust based on actual usage
filecoin-pin payments fund --days 30
```

**Why skip auto-fund:**
- Want longer runway than 10 days
- Want to control deposit timing
- Want to optimize for gas costs (batch deposits)

## Complete CLI Reference

```bash
# Add with auto-funding
filecoin-pin add --auto-fund <path>

# Import CAR with auto-funding
filecoin-pin import --auto-fund <car-file>

# Check current status (no auto-fund here)
filecoin-pin payments status

# Manual funding adjustment
filecoin-pin payments fund --days 30
filecoin-pin payments fund --amount 100
```

## Technical Constants

From `src/common/constants.ts`:

```typescript
/**
 * Minimum runway in days to ensure WarmStorage can cover costs.
 * Used when `--auto-fund` is passed to import or add commands
 */
export const MIN_RUNWAY_DAYS = 10
```

## Version Availability

- ❌ v0.6.0 and earlier - NOT available
- ✅ v0.7.0+ - Available on `add` and `import` commands

To check your version:
```bash
filecoin-pin -V
```

To upgrade:
```bash
npm install -g filecoin-pin@latest
```

## Summary for Documentation

**One-sentence description:**
`--auto-fund` automatically ensures 10-day payment runway before each upload by calculating exact funding needs based on the file being uploaded.

**When to use:**
- CI/CD pipelines
- Automated upload workflows
- When you want "set it and forget it" funding

**When NOT to use:**
- You want > 10 days runway
- You want manual control over deposits
- You're optimizing for gas costs
- You're uploading many small files (inefficient to check each time)
